using MPAlign
using Test
using Test
using LightGraphs
using LinearAlgebra

@testset "MPAlign" begin
    n = 20
    λ = 3
    s = 0.4

    data_check = [[2.554459, -1.346828, 1.013629, -0.615002, -0.975230, 1.207213, -0.051287, -2.375779, -0.975230, -0.200246, 1.101704, -0.472741, -1.331169, -0.848312, -0.051287, -2.375779, -0.167027, 1.528282, -2.375779, -2.375779],
    [-0.184265, 0.524227, 0.093951, 0.178841, -0.287554, 0.047793, -0.366399, 0.178349, -0.287554, -0.352418, 0.222273, 0.623926, 0.130005, -0.239924, -0.366399, 0.178349, 0.387049, 0.790944, 0.178349, 0.178349],
    [-1.494844, -0.004521, -0.126428, 0.594263, 0.984577, 0.414440, 0.989069, 0.178349, 0.984577, 0.781970, -0.220506, 0.003317, 0.733688, 0.935675, 0.989069, 0.178349, 0.558987, -0.650504, 0.178349, 0.178349],
    [-2.375779, 0.689174, -0.843302, 0.178349, 0.178349, -0.843302, -0.332477, 1.200000, 0.178349, -0.332477, -0.843302, 0.178349, 0.689174, 0.178349, -0.332477, 1.200000, 0.178349, -0.843302, 1.200000, 1.200000],
    [-2.375779, 0.689174, -0.843302, 0.178349, 0.178349, -0.843302, -0.332477, 1.200000, 0.178349, -0.332477, -0.843302, 0.178349, 0.689174, 0.178349, -0.332477, 1.200000, 0.178349, -0.843302, 1.200000, 1.200000],
    [2.227597, -0.957353, 1.440599, -0.678833, -1.093163, 1.075827, -0.318501, -1.864954, -1.093163, -0.418694, 1.500382, -0.265845, -1.100465, -0.924522, -0.318501, -1.864954, 0.002392, 1.700918, -1.864954, -1.864954],
    [1.457630, -0.601845, 1.013347, 0.487322, -0.073449, 0.755498, 0.264249, -1.354128, -0.073449, 0.369071, 1.168702, -0.053885, -0.724662, -0.073463, 0.264249, -1.354128, 0.316029, 1.425065, -1.354128, -1.354128],
    [-0.885897, 0.247145, -0.001501, 0.322286, 0.486080, 0.467487, 0.354896, 0.178349, 0.486080, 0.211582, -0.004608, 0.285872, 0.593118, 0.339161, 0.354896, 0.178349, 0.628307, 0.091947, 0.178349, 0.178349],
    [-0.954578, -0.284592, 0.163629, 0.827259, 1.029978, 0.494080, 1.198952, -0.332477, 1.029978, 1.065663, 0.074967, -0.122873, 0.296726, 0.991634, 1.198952, -0.332477, 0.506253, -0.449332, -0.332477, -0.332477],
    [-1.793645, -0.087575, -0.514993, 0.815151, 1.238781, 0.044013, 1.139419, 0.178349, 1.238781, 1.010177, -0.601054, -0.085596, 0.616506, 1.167244, 1.139419, 0.178349, 0.279952, -1.109414, 0.178349, 0.178349],
    [-1.494844, -0.004521, -0.126428, 0.594263, 0.984577, 0.414440, 0.989069, 0.178349, 0.984577, 0.781970, -0.220506, 0.003317, 0.733688, 0.935675, 0.989069, 0.178349, 0.558987, -0.650504, 0.178349, 0.178349],
    [-1.323959, 0.646442, -0.438503, 0.204155, 0.155202, -0.247447, -0.168178, 0.689174, 0.155202, -0.210661, -0.396930, 0.398289, 0.568804, 0.099775, -0.168178, 0.689174, 0.356128, -0.110561, 0.689174, 0.689174],
    [-1.278386, 0.673417, -0.346934, 0.221034, 0.034597, -0.313825, -0.211020, 0.689174, 0.034597, -0.224443, -0.303950, 0.422651, 0.489912, 0.073833, -0.211020, 0.689174, 0.318855, -0.095885, 0.689174, 0.689174],
    [-0.516603, -0.199114, 0.753929, 0.719172, 0.606255, 0.502954, 0.765130, -0.332477, 0.606255, 0.799976, 0.656983, 0.020333, 0.140557, 0.637789, 0.765130, -0.332477, 0.587032, 0.095781, -0.332477, -0.332477],
    [-0.524234, 0.398365, 0.117482, 0.174511, -0.047988, 0.265530, 0.009865, 0.178349, -0.047988, -0.084587, 0.187006, 0.613759, 0.326588, 0.051653, 0.009865, 0.178349, 0.455814, 0.471236, 0.178349, 0.178349],
    [-2.126634, 0.287073, -0.633868, 0.787181, 0.894609, -0.360548, 0.570338, 0.689174, 0.894609, 0.521494, -0.687224, 0.088912, 0.726697, 0.898115, 0.570338, 0.689174, 0.279251, -1.008489, 0.689174, 0.689174],
    [-1.091078, -0.374393, -0.032651, 0.750047, 1.150923, 0.380182, 1.243659, -0.332477, 1.150923, 1.194621, -0.150130, -0.165855, 0.365714, 1.006261, 1.243659, -0.332477, 0.334640, -0.776113, -0.332477, -0.332477],
    [0.458638, -0.379748, 0.894856, 0.402349, 0.220159, 1.223579, 0.596386, -0.843302, 0.220159, 0.488143, 0.903540, 0.001057, -0.109334, 0.247049, 0.596386, -0.843302, 0.646117, 0.882290, -0.843302, -0.843302],
    [-1.614477, -0.040615, -0.129549, 0.705434, 1.083739, 0.099925, 0.960101, 0.178349, 1.083739, 0.845376, -0.242586, -0.045018, 0.603338, 0.974986, 0.960101, 0.178349, 0.424062, -0.764559, 0.178349, 0.178349],
    [-2.375779, 0.689174, -0.843302, 0.178349, 0.178349, -0.843302, -0.332477, 1.200000, 0.178349, -0.332477, -0.843302, 0.178349, 0.689174, 0.178349, -0.332477, 1.200000, 0.178349, -0.843302, 1.200000, 1.200000]]

    data_check2 = [[2.341680, -1.365904, 0.499407, -1.071828, -1.350649, 0.502508, -0.749434, -2.375779, -1.350649, -0.749434, 0.619942, -0.578132, -1.634333, -1.350649, -0.749434, -2.375779, -0.704786, 1.158504, -2.375779, -2.375779],
    [-0.261587, 0.519571, -0.014854, 0.123443, -0.244960, 0.022747, -0.380084, 0.178349, -0.244960, -0.380084, 0.128128, 0.586818, 0.138806, -0.244960, -0.380084, 0.178349, 0.367401, 0.741968, 0.178349, 0.178349],
    [-1.501218, 0.004633, -0.325959, 0.191606, 0.378259, -0.323899, 0.236592, 0.178349, 0.378259, 0.236592, -0.403680, -0.092076, 0.237215, 0.378259, 0.236592, 0.178349, -0.001149, -0.822246, 0.178349, 0.178349],
    [-2.375779, 0.689174, -0.843302, 0.178349, 0.178349, -0.843302, -0.332477, 1.200000, 0.178349, -0.332477, -0.843302, 0.178349, 0.689174, 0.178349, -0.332477, 1.200000, 0.178349, -0.843302, 1.200000, 1.200000],
    [-2.375779, 0.689174, -0.843302, 0.178349, 0.178349, -0.843302, -0.332477, 1.200000, 0.178349, -0.332477, -0.843302, 0.178349, 0.689174, 0.178349, -0.332477, 1.200000, 0.178349, -0.843302, 1.200000, 1.200000],
    [2.018585, -0.969421, 0.598961, -0.822562, -1.070465, 0.581264, -0.564170, -1.864954, -1.070465, -0.564170, 0.697033, -0.342649, -1.215544, -1.070465, -0.564170, -1.864954, -0.408870, 1.138457, -1.864954, -1.864954],
    [1.250451, -0.601541, 0.369529, -0.311584, -0.620295, 0.394170, -0.301323, -1.354128, -0.620295, -0.301323, 0.490080, -0.104822, -0.883136, -0.620295, -0.301323, -1.354128, -0.225144, 0.998711, -1.354128, -1.354128],
    [-0.831924, 0.279415, -0.096843, 0.174277, 0.090550, -0.089423, -0.030350, 0.178349, 0.090550, -0.030350, -0.079310, 0.249045, 0.219000, 0.090550, -0.030350, 0.178349, 0.222042, -0.055388, 0.178349, 0.178349],
    [-1.052070, -0.291206, -0.198370, 0.151353, 0.282696, -0.184892, 0.304574, -0.332477, 0.282696, 0.304574, -0.268838, -0.225338, -0.111559, 0.282696, 0.304574, -0.332477, -0.149511, -0.676936, -0.332477, -0.332477],
    [-1.847771, -0.089896, -0.523658, 0.277113, 0.494442, -0.501378, 0.311430, 0.178349, 0.494442, 0.311430, -0.611657, -0.203051, 0.193373, 0.494442, 0.311430, 0.178349, -0.120488, -1.101600, 0.178349, 0.178349],
    [-1.501218, 0.004633, -0.325959, 0.191606, 0.378259, -0.323899, 0.236592, 0.178349, 0.378259, 0.236592, -0.403680, -0.092076, 0.237215, 0.378259, 0.236592, 0.178349, -0.001149, -0.822246, 0.178349, 0.178349],
    [-1.315154, 0.652493, -0.352207, 0.208426, 0.037262, -0.345487, -0.264559, 0.689174, 0.037262, -0.264559, -0.300586, 0.397119, 0.468357, 0.037262, -0.264559, 0.689174, 0.331796, -0.085008, 0.689174, 0.689174],
    [-1.315154, 0.652493, -0.352207, 0.208426, 0.037262, -0.345487, -0.264559, 0.689174, 0.037262, -0.264559, -0.300586, 0.397119, 0.468357, 0.037262, -0.264559, 0.689174, 0.331796, -0.085008, 0.689174, 0.689174],
    [-0.706605, -0.196349, -0.037332, 0.104717, 0.173243, -0.040016, 0.220251, -0.332477, 0.173243, 0.220251, -0.085279, -0.118141, -0.092777, 0.173243, 0.220251, -0.332477, -0.047669, -0.362737, -0.332477, -0.332477],
    [-0.564017, 0.397119, -0.066722, 0.154819, -0.071520, -0.032644, -0.202631, 0.178349, -0.071520, -0.202631, 0.018228, 0.475945, 0.182361, -0.071520, -0.202631, 0.178349, 0.300224, 0.336306, 0.178349, 0.178349],
    [-2.175616, 0.283536, -0.703951, 0.359891, 0.461001, -0.683502, 0.086742, 0.689174, 0.461001, 0.086742, -0.750165, -0.009726, 0.458666, 0.461001, 0.086742, 0.689174, 0.028317, -1.024733, 0.689174, 0.689174],
    [-1.219802, -0.366465, -0.246839, 0.114520, 0.333389, -0.239310, 0.359074, -0.332477, 0.333389, 0.359074, -0.346562, -0.318640, -0.101530, 0.333389, 0.359074, -0.332477, -0.206998, -0.882055, -0.332477, -0.332477],
    [0.423066, -0.362742, 0.308715, -0.153433, -0.258866, 0.306032, -0.035438, -0.843302, -0.258866, -0.035438, 0.333311, -0.054647, -0.446516, -0.258866, -0.035438, -0.843302, -0.063714, 0.393139, -0.843302, -0.843302],
    [-1.667888, -0.033709, -0.427301, 0.251748, 0.440922, -0.415132, 0.276257, 0.178349, 0.440922, 0.276257, -0.506857, -0.143111, 0.211547, 0.440922, 0.276257, 0.178349, -0.058401, -0.943435, 0.178349, 0.178349],
    [-2.375779, 0.689174, -0.843302, 0.178349, 0.178349, -0.843302, -0.332477, 1.200000, 0.178349, -0.332477, -0.843302, 0.178349, 0.689174, 0.178349, -0.332477, 1.200000, 0.178349, -0.843302, 1.200000, 1.200000]
    ]

    G1, G2 = read_graphs(n,"graphs_20.txt")
    PG = Pair_IO(G1,G2,n,λ,s)
    M_data = create_matrix_check(data_check2)
    @testset "message passing" begin
    @test check_data(PG,M_data,1)
    M_data = create_matrix_check(data_check)
    @test check_data(PG,M_data,4)
    end
    @testset "overlap function" begin
    ov1, _, v1, _ = eval_M(PG,Matrix(I,n,n))
    @test ov1 == n 
    @test v1 == n
    end
    @testset "matched edges" begin
    m1, m2 = match_edges(PG,1:n,1:n)
    @test m1 == m2
    @test m2 == ne(intersect(PG.N1.G,PG.N2.G))
    end
    n = 100
    λ = 3
    s = 1#0.55
    PG = Pair_ER(n,λ,s)
    m1, m2 = match_edges(PG,PG.perm_G1G2,PG.perm_G2G1)
    @test m1 == m2
    @test m1 == ne(PG.Ginter)
    
    delta = 0
    for t in 0:0.1:1
        a,b = MPAlign.compute_ab(n,λ,t)
        delta += (a+(1-a)*b^2 - λ*s/n)^2+((1-a)*b*(1-b) - λ*(1-s)/n)^2
    end
    @test delta < 0.01
end
